# üìö Guide Complet : Middlewares & Rate Limiting

## üéì Cours Complet sur les Middlewares

### üìñ Qu'est-ce qu'un Middleware ?

Un **middleware** est une **couche interm√©diaire** qui s'ex√©cute **AVANT** votre code m√©tier pour :

```
Requ√™te HTTP ‚Üí Middleware ‚Üí Votre Code ‚Üí R√©ponse
```

**Analogie Simple :**
Imaginez un **agent de s√©curit√© √† l'entr√©e d'un b√¢timent** :
1. Il v√©rifie votre identit√© (authentification)
2. Il v√©rifie vos permissions (autorisation)
3. Il v√©rifie que vous n'entrez pas trop souvent (rate limiting)
4. Il fouille votre sac (validation des donn√©es)

Le middleware fait **exactement la m√™me chose** pour votre API !

---

## üéØ Pourquoi utiliser des Middlewares ?

### ‚ùå Sans Middleware (Code R√©p√©titif)

```php
// Route 1: Login
require_method('POST');
if (!rate_limit(5, 300)) exit;
$json = file_get_contents('php://input');
$data = json_decode($json, true);
if (!isset($data['email'])) { /* erreur */ }
if (!filter_var($data['email'], FILTER_VALIDATE_EMAIL)) { /* erreur */ }
// ... 20 lignes de validation ...
// ENFIN votre code m√©tier

// Route 2: Register
require_method('POST');
if (!rate_limit(3, 3600)) exit;
$json = file_get_contents('php://input');
$data = json_decode($json, true);
if (!isset($data['email'])) { /* erreur */ }
// ... ENCORE les m√™mes 20 lignes ...
```

**Probl√®mes :**
- üò´ Code dupliqu√© partout
- üêõ Bugs si vous oubliez une validation
- üîß Difficile √† maintenir
- üìù Trop de lignes

### ‚úÖ Avec Middleware (Code Propre)

```php
// Route 1: Login
require_method('POST');
$data = middleware([
    'rate' => [5, 300],
    'json' => ['email', 'password'],
    'sanitize' => ['email' => 'email']
]);
if (!$data) exit;

// DIRECT √Ä VOTRE CODE M√âTIER
$user = loginUser($data['email'], $data['password']);

// Route 2: Register  
require_method('POST');
$data = middleware([
    'rate' => [3, 3600],
    'json' => ['email', 'password', 'name']
]);
if (!$data) exit;

// DIRECT √Ä VOTRE CODE M√âTIER
$user = registerUser($data);
```

**Avantages :**
- ‚úÖ Code court et lisible
- ‚úÖ Pas de duplication
- ‚úÖ Validation garantie
- ‚úÖ Facile √† maintenir

---

## üöÄ Le Syst√®me de Middleware StructureOne

### Principe : Une Fonction, Tout G√©rer

StructureOne utilise **UNE SEULE fonction** pour g√©rer TOUS vos besoins :

```php
middleware([
    'rate' => [max, secondes],           // Rate limiting
    'auth' => true,                      // Authentification
    'role' => ['admin'],                 // Autorisation
    'json' => ['champ1', 'champ2'],     // Validation JSON
    'optional' => ['champ' => defaut],   // Champs optionnels
    'sanitize' => ['champ' => 'type'],   // Nettoyage
    'validate' => function($data) {}     // Validation custom
]);
```

---

## üìù Utilisation √âtape par √âtape

### Niveau 1 : Validation JSON Simple

**Cas d'usage :** Route publique qui re√ßoit des donn√©es JSON

```php
<?php
// core/routes/contact/index.php
require_method('POST');

try {
    // Valider que email, nom et message sont pr√©sents
    $data = middleware([
        'json' => ['email', 'nom', 'message']
    ]);
    
    if (!$data) exit; // Erreur d√©j√† envoy√©e automatiquement
    
    // Utiliser les donn√©es valid√©es
    $email = $data['email'];
    $nom = $data['nom'];
    $message = $data['message'];
    
    // Envoyer email, sauver en BDD, etc.
    sendContactEmail($email, $nom, $message);
    
    echo api_response(200, "Message envoy√© avec succ√®s");
    
} catch(Exception $e) {
    echo getError($e);
}
?>
```

**Test :**
```bash
curl -X POST http://localhost:8080/api/contact \
  -H "Content-Type: application/json" \
  -d '{"email":"user@test.com","nom":"John","message":"Hello"}'
```

---

### Niveau 2 : Avec Rate Limiting

**Cas d'usage :** Prot√©ger contre les abus

```php
<?php
// core/routes/newsletter/index.php
require_method('POST');

try {
    // Rate limit : max 3 inscriptions par heure depuis une IP
    $data = middleware([
        'rate' => [3, 3600],  // [3 requ√™tes, 3600 secondes]
        'json' => ['email']
    ]);
    
    if (!$data) exit;
    
    // Inscrire √† la newsletter
    subscribeNewsletter($data['email']);
    
    echo api_response(200, "Inscription r√©ussie");
    
} catch(Exception $e) {
    echo getError($e);
}
?>
```

**Comportement :**
- 1√®re requ√™te : ‚úÖ OK
- 2√®me requ√™te : ‚úÖ OK
- 3√®me requ√™te : ‚úÖ OK
- 4√®me requ√™te : ‚ùå 429 Too Many Requests (attendre 1 heure)

**Headers retourn√©s automatiquement :**
```
X-RateLimit-Limit: 3
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1698765432
Retry-After: 3542
```

---

### Niveau 3 : Avec Authentification

**Cas d'usage :** Route r√©serv√©e aux utilisateurs connect√©s

```php
<?php
// core/routes/profile/index.php
require_method('GET');

try {
    // Requiert un token JWT valide
    $data = middleware([
        'auth' => true,
        'rate' => [60, 60]  // 60 requ√™tes par minute
    ]);
    
    if (!$data) exit; // 401 si pas de token
    
    // R√©cup√©rer les infos utilisateur du token
    $user = middleware_auth();
    
    // Utiliser $user['id'], $user['email'], etc.
    $profile = getUserProfile($user['id']);
    
    echo api_response(200, "Profil", $profile);
    
} catch(Exception $e) {
    echo getError($e);
}
?>
```

**Test :**
```bash
curl http://localhost:8080/api/profile \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

---

### Niveau 4 : Avec Autorisation (R√¥les)

**Cas d'usage :** Route r√©serv√©e aux admins

```php
<?php
// core/routes/admin/users/index.php
require_method('GET');

try {
    // Requiert auth + r√¥le admin
    $data = middleware([
        'auth' => true,
        'role' => ['admin', 'moderator'],  // Liste des r√¥les autoris√©s
        'rate' => [100, 60]
    ]);
    
    if (!$data) exit; // 403 si r√¥le insuffisant
    
    // Code r√©serv√© aux admins
    $allUsers = getAllUsers();
    
    echo api_response(200, "Liste des utilisateurs", $allUsers);
    
} catch(Exception $e) {
    echo getError($e);
}
?>
```

**Le token JWT doit contenir :**
```json
{
  "id": 123,
  "email": "admin@example.com",
  "role": "admin"
}
```

---

### Niveau 5 : Avec Sanitization

**Cas d'usage :** Nettoyer automatiquement les donn√©es pour √©viter XSS

```php
<?php
// core/routes/comments/index.php
require_method('POST');

try {
    $data = middleware([
        'auth' => true,
        'rate' => [10, 60],
        'json' => ['post_id', 'comment'],
        'sanitize' => [
            'post_id' => 'int',      // Convertir en entier
            'comment' => 'string'     // √âchapper HTML/XSS
        ]
    ]);
    
    if (!$data) exit;
    
    $user = middleware_auth();
    
    // $data['comment'] est maintenant nettoy√© (pas de <script>, etc.)
    saveComment($user['id'], $data['post_id'], $data['comment']);
    
    echo api_response(201, "Commentaire ajout√©");
    
} catch(Exception $e) {
    echo getError($e);
}
?>
```

**Types de sanitization disponibles :**
- `'email'` - Nettoie un email
- `'url'` - Nettoie une URL
- `'int'` - Convertit en entier
- `'float'` - Convertit en d√©cimal
- `'html'` - √âchappe les balises HTML
- `'string'` - Nettoyage g√©n√©ral (d√©faut)

---

### Niveau 6 : Avec Validation Personnalis√©e

**Cas d'usage :** R√®gles de validation complexes

```php
<?php
// core/routes/register/index.php
require_method('POST');

try {
    $data = middleware([
        'rate' => [3, 3600],  // 3 inscriptions par heure max
        'json' => ['email', 'password', 'username'],
        'sanitize' => [
            'email' => 'email',
            'username' => 'string'
        ],
        'validate' => function($data) {
            // Validation email
            if (!filter_var($data['email'], FILTER_VALIDATE_EMAIL)) {
                return "Email invalide";
            }
            
            // Validation mot de passe
            if (strlen($data['password']) < 8) {
                return "Le mot de passe doit contenir au moins 8 caract√®res";
            }
            if (!preg_match('/[A-Z]/', $data['password'])) {
                return "Le mot de passe doit contenir au moins une majuscule";
            }
            if (!preg_match('/[0-9]/', $data['password'])) {
                return "Le mot de passe doit contenir au moins un chiffre";
            }
            
            // Validation username
            if (strlen($data['username']) < 3) {
                return "Le nom d'utilisateur doit contenir au moins 3 caract√®res";
            }
            if (!preg_match('/^[a-zA-Z0-9_]+$/', $data['username'])) {
                return "Le nom d'utilisateur ne peut contenir que des lettres, chiffres et _";
            }
            
            // V√©rifier si l'email existe d√©j√†
            if (db_element_exist('users', ['email' => $data['email']])) {
                return "Cet email est d√©j√† utilis√©";
            }
            
            // V√©rifier si le username existe d√©j√†
            if (db_element_exist('users', ['username' => $data['username']])) {
                return "Ce nom d'utilisateur est d√©j√† pris";
            }
            
            return true; // ‚úÖ Validation r√©ussie
        }
    ]);
    
    if (!$data) exit;
    
    // Cr√©er l'utilisateur
    $userId = createUser($data);
    
    // G√©n√©rer token JWT
    $token = jwt_generate([
        'id' => $userId,
        'email' => $data['email'],
        'role' => 'user'
    ]);
    
    echo api_response(201, "Inscription r√©ussie", ['token' => $token]);
    
} catch(Exception $e) {
    echo getError($e);
}
?>
```

---

### Niveau 7 : Tout Combin√© (Exemple Complet)

```php
<?php
// core/routes/posts/index.php (POST)
require_method('POST');

try {
    $data = middleware([
        // 1. Rate limiting
        'rate' => [10, 60],  // 10 posts par minute max
        
        // 2. Authentification
        'auth' => true,
        
        // 3. Validation JSON
        'json' => ['title', 'content'],
        'optional' => [
            'published' => false,
            'tags' => []
        ],
        
        // 4. Sanitization
        'sanitize' => [
            'title' => 'string',
            'content' => 'string'
        ],
        
        // 5. Validation personnalis√©e
        'validate' => function($data) {
            if (strlen($data['title']) < 3 || strlen($data['title']) > 200) {
                return "Le titre doit contenir entre 3 et 200 caract√®res";
            }
            if (strlen($data['content']) < 10) {
                return "Le contenu doit contenir au moins 10 caract√®res";
            }
            if (isset($data['tags']) && count($data['tags']) > 10) {
                return "Maximum 10 tags autoris√©s";
            }
            return true;
        }
    ]);
    
    if (!$data) exit;
    
    $user = middleware_auth();
    
    // Cr√©er le post
    $post = createPost([
        'user_id' => $user['id'],
        'title' => $data['title'],
        'content' => $data['content'],
        'published' => $data['published'],
        'tags' => $data['tags']
    ]);
    
    echo api_response(201, "Post cr√©√© avec succ√®s", $post);
    
} catch(Exception $e) {
    echo getError($e);
}
?>
```

---

## üö¶ Le Rate Limiting en D√©tail

### Qu'est-ce que le Rate Limiting ?

Le **rate limiting** (limitation de taux) consiste √† **limiter le nombre de requ√™tes** qu'un utilisateur peut faire **dans une p√©riode donn√©e**.

**Analogie :**
Comme un **distributeur automatique de billets** qui limite √† 3 retraits par jour pour √©viter la fraude.

### Pourquoi c'est Important ?

#### 1. Protection contre le Force Brute

**Sans rate limiting :**
```
Attaquant essaie 1 000 000 de mots de passe en 1 heure
‚Üí Compte pirat√© ‚ùå
```

**Avec rate limiting :**
```
Attaquant bloqu√© apr√®s 5 tentatives
‚Üí Doit attendre 5 minutes entre chaque tentative
‚Üí 1 000 000 essais = 3 472 jours (9,5 ans!)
‚Üí Compte prot√©g√© ‚úÖ
```

#### 2. Protection contre le DDoS

**Sans rate limiting :**
```
Attaquant envoie 10 000 requ√™tes/seconde
‚Üí Serveur surcharg√©
‚Üí Site down pour tout le monde ‚ùå
```

**Avec rate limiting :**
```
Max 60 requ√™tes/minute par IP
‚Üí Attaquant bloqu√© automatiquement
‚Üí Site fonctionne normalement ‚úÖ
```

#### 3. Protection des Ressources

**Sans rate limiting :**
```
Robot scrap tout votre site
‚Üí 10 000 requ√™tes en 5 minutes
‚Üí Serveur lent pour les vrais utilisateurs ‚ùå
```

**Avec rate limiting :**
```
Max 100 requ√™tes/minute
‚Üí Robot ralenti
‚Üí Performances maintenues ‚úÖ
```

### Configuration du Rate Limiting

```php
middleware([
    'rate' => [max_requetes, fenetre_secondes]
]);
```

**Exemples de configuration :**

| Route | Config | Usage |
|-------|--------|-------|
| `/api/login` | `[5, 300]` | 5 tentatives par 5 min (force brute) |
| `/api/register` | `[3, 3600]` | 3 inscriptions par heure (spam) |
| `/api/search` | `[100, 60]` | 100 recherches par minute (usage normal) |
| `/api/upload` | `[10, 600]` | 10 uploads par 10 min (bande passante) |
| `/api/posts` (POST) | `[10, 60]` | 10 posts par minute (spam) |
| `/api/posts` (GET) | `[1000, 60]` | 1000 lectures par minute (public) |

### Comment √ßa Marche Techniquement ?

```
1. Requ√™te arrive
2. Syst√®me r√©cup√®re l'IP
3. V√©rifie le fichier cache : /core/cache/rate_limit_IP_ROUTE.json
4. Compte les requ√™tes dans la fen√™tre de temps
5. Si < max : OK, ajouter cette requ√™te
   Si >= max : Bloquer, retourner 429
```

**Fichier cache exemple :**
```json
[1698765432, 1698765445, 1698765459, 1698765471, 1698765489]
```
= 5 timestamps des 5 derni√®res requ√™tes

**Avantages :**
- ‚úÖ Pas de base de donn√©es requise
- ‚úÖ Rapide (lecture/√©criture fichier)
- ‚úÖ Auto-nettoyage des anciennes entr√©es
- ‚úÖ Par IP et par route

---

## üì¶ Fonctions Raccourcies

Pour les cas simples, utilisez les fonctions raccourcies :

```php
// JSON uniquement
$data = middleware_json(['email', 'password']);

// Auth uniquement
$user = middleware_auth();

// Rate limit uniquement
middleware_rate(60, 60); // 60/min
```

---

## üé® Patterns Courants

### Pattern 1: API Publique

```php
// Route publique avec rate limit g√©n√©reux
$data = middleware([
    'rate' => [100, 60]
]);
```

### Pattern 2: Login/Register

```php
// Rate limit strict + validation compl√®te
$data = middleware([
    'rate' => [5, 300],
    'json' => ['email', 'password'],
    'sanitize' => ['email' => 'email'],
    'validate' => function($data) {
        // Validation password, email, etc.
    }
]);
```

### Pattern 3: CRUD Authentifi√©

```php
// Auth + rate limit mod√©r√©
$data = middleware([
    'auth' => true,
    'rate' => [60, 60],
    'json' => ['field1', 'field2']
]);
```

### Pattern 4: Admin

```php
// Auth + role admin
$data = middleware([
    'auth' => true,
    'role' => ['admin'],
    'rate' => [100, 60]
]);
```

---

## üß™ Tester Vos Middlewares

### Test Rate Limiting

```bash
# Envoyer 10 requ√™tes rapidement
for i in {1..10}; do
  echo "Request $i:"
  curl http://localhost:8080/api/mon_endpoint
  echo ""
done
```

**R√©sultat attendu :**
```
Request 1: 200 OK
Request 2: 200 OK
Request 3: 200 OK
Request 4: 200 OK
Request 5: 200 OK
Request 6: 429 Too Many Requests
```

### Test Authentification

```bash
# Sans token
curl http://localhost:8080/api/protected
# ‚Üí 401 Unauthorized

# Avec token
curl http://localhost:8080/api/protected \
  -H "Authorization: Bearer VOTRE_TOKEN"
# ‚Üí 200 OK
```

### Test Validation

```bash
# Donn√©es manquantes
curl -X POST http://localhost:8080/api/contact \
  -H "Content-Type: application/json" \
  -d '{"email":"test@test.com"}'
# ‚Üí 400 Bad Request (champ 'message' manquant)

# Donn√©es compl√®tes
curl -X POST http://localhost:8080/api/contact \
  -H "Content-Type: application/json" \
  -d '{"email":"test@test.com","nom":"John","message":"Hello"}'
# ‚Üí 200 OK
```

---

## ‚úÖ Checklist Middleware

Avant de cr√©er une route, demandez-vous :

```
‚òê Est-ce une route publique ou priv√©e ?
   ‚Üí Si priv√©e : 'auth' => true

‚òê Y a-t-il des r√¥les sp√©cifiques ?
   ‚Üí Si oui : 'role' => ['admin']

‚òê Faut-il prot√©ger contre les abus ?
   ‚Üí Toujours ! 'rate' => [max, window]

‚òê Quels sont les champs JSON requis ?
   ‚Üí 'json' => ['champ1', 'champ2']

‚òê Y a-t-il des champs optionnels ?
   ‚Üí 'optional' => ['champ' => defaut]

‚òê Faut-il nettoyer les donn√©es (XSS) ?
   ‚Üí 'sanitize' => ['champ' => 'type']

‚òê Y a-t-il des r√®gles de validation complexes ?
   ‚Üí 'validate' => function($data) {}
```

---

## üéì R√©sum√© Final

**Middleware = Gardien de s√©curit√© de votre API**

**Un seul appel :**
```php
$data = middleware([...]);
if (!$data) exit;
```

**G√®re automatiquement :**
- ‚úÖ Rate limiting (protection abus)
- ‚úÖ Authentification JWT
- ‚úÖ Autorisation par r√¥les
- ‚úÖ Validation JSON
- ‚úÖ Sanitization XSS
- ‚úÖ Validation personnalis√©e
- ‚úÖ R√©ponses HTTP standardis√©es

**R√©sultat :**
- üìù Code 70% plus court
- üõ°Ô∏è S√©curit√© maximale
- üêõ Moins de bugs
- üöÄ D√©veloppement rapide

---

**üéâ Vous ma√Ætrisez maintenant les middlewares ! Bon d√©veloppement ! üöÄ**
